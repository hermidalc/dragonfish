import re
from glob import glob
from os import getcwd, walk
from os.path import dirname, exists, isdir, join, splitext
from shutil import rmtree

import pandas as pd
from snakemake.utils import validate

CONFIG_DIR = "config"
DATA_DIR = "data"
LOG_DIR = "logs"
RESOURCES_DIR = "resources"
RESULTS_DIR = "results"
RULES_DIR = "rules"


configfile: join(CONFIG_DIR, "config.yaml")


STUDY_NAME = config["study"]["name"]
SAMPLE_CONFIG_FILE = config["study"]["samples"]
UNIT_CONFIG_FILE = config["study"]["units"]

TEMP_DIR = config["tmp_dir"]

SAMPLE_DF = pd.read_csv(
    SAMPLE_CONFIG_FILE, sep="\t", dtype={"sample_name": str, "sample_label": str}
).set_index("sample_name", drop=False, verify_integrity=True)
validate(SAMPLE_DF, schema="schemas/samples.schema.yaml")

UNIT_DF = pd.read_csv(
    UNIT_CONFIG_FILE, sep="\t", dtype={"sample_name": str, "unit_name": str}
)
validate(UNIT_DF, schema="schemas/units.schema.yaml")

if UNIT_DF["unit_name"].isna().all():
    UNIT_DF.set_index("sample_name", inplace=True, drop=False, verify_integrity=True)
    RUN_ID_WILDCARD_STR = "{sample}"
    SAMPLES = UNIT_DF["sample_name"].tolist()
    EXPAND_PARAMS = {"sample": SAMPLES}
else:
    UNIT_DF.set_index(
        ["sample_name", "unit_name"], inplace=True, drop=False, verify_integrity=True
    )
    RUN_ID_WILDCARD_STR = "{sample}_{unit}"
    SAMPLES = UNIT_DF["sample_name"].tolist()
    UNITS = UNIT_DF["unit_name"].tolist()
    EXPAND_PARAMS = {"sample": SAMPLES, "unit": UNITS}

SAMPLE_DF = SAMPLE_DF.loc[SAMPLES]

SAMPLE_LABELS = [
    n if pd.isna(l) else l
    for n, l in zip(SAMPLE_DF["sample_name"], SAMPLE_DF["sample_label"])
]

EXPAND_PARAMS["data_subdir"] = [dirname(fq) for fq in UNIT_DF["fq1"]]

UNIPROT_DIR = join(RESOURCES_DIR, "uniprot")
NCBI_GENOME_DIR = join(RESOURCES_DIR, "genomes")
NCBI_ASSEMBLY_DIR = join(NCBI_GENOME_DIR, "assemblies")
NCBI_TAXONOMY_DIR = join(RESOURCES_DIR, "taxonomy")
GENCODE_DIR = join(RESOURCES_DIR, "gencode")
REF_DIR = join(RESOURCES_DIR, "ref")
PUFFERFISH_RESOURCES_DIR = join(RESOURCES_DIR, "pufferfish")

UNIPROT_KB_URL = config["uniprot"]["kb"]["url"]
UNIPROT_KB_TYPES = config["uniprot"]["kb"]["types"]
UNIPROT_KB_IDMAP_URL = config["uniprot"]["kb"]["idmap"]["url"]
UNIPROT_KB_IDMAP_FILENAME = config["uniprot"]["kb"]["idmap"]["filename"]

NCBI_ASSEMBLY_SUMMARY_URL = config["ncbi"]["assembly"]["summary"]["url"]
NCBI_ASSEMBLY_SUMMARY_FILENAMES = config["ncbi"]["assembly"]["summary"]["filenames"]

GENCODE_PROTOCOL = config["gencode"]["protocol"]
GENCODE_REGIONS = config["gencode"]["regions"]
GENCODE_ANNOT_FMT = config["gencode"]["annot"]["fmt"]

FASTQ_DATA_DIR = config["fastq"]["data_dir"]
FASTQ_MATES = config["fastq"]["mates"]
FASTQ_EXT = config["fastq"]["ext"]
FASTQ_PLATFORM = config["fastq"]["platform"]

NCBI_ACC2TAXID_URL = config["ncbi"]["taxonomy"]["acc2taxid"]["url"]
NCBI_ACC2TAXID_FILENAMES = config["ncbi"]["taxonomy"]["acc2taxid"]["filenames"]
NCBI_TAXDUMP_URL = config["ncbi"]["taxonomy"]["taxdump"]["url"]
NCBI_TAXDUMP_ZIP_FILENAME = config["ncbi"]["taxonomy"]["taxdump"]["zip_filename"]
NCBI_TAXDUMP_FILENAMES = config["ncbi"]["taxonomy"]["taxdump"]["filenames"]

EXPAND_PARAMS["ukb_basename"] = [f"uniprot_{t}" for t in UNIPROT_KB_TYPES]
EXPAND_PARAMS["ukb_dbxref_db"] = [
    db.lower() for db in config["uniprot"]["kb"]["dbxref"]["dbs"]
]

UNIPROT_PROTEOMES_FILE = join(UNIPROT_DIR, "uniprot_proteomes.tsv")
UNIPROT_KB_XML_URL = join(UNIPROT_KB_URL, "{ukb_basename}.xml.gz")
UNIPROT_KB_XML_FILE = join(UNIPROT_DIR, "{ukb_basename}.xml.gz")
UNIPROT_KB_FASTA_URL = join(UNIPROT_KB_URL, "{ukb_basename}.fasta.gz")
UNIPROT_KB_FASTA_FILE = join(UNIPROT_DIR, "{ukb_basename}.fasta.gz")
UNIPROT_KB_XML_SPLIT_POS_FILE = join(UNIPROT_DIR, "{ukb_basename}_xml_split_pos.txt")
UNIPROT_KB_DBXREF_SPLIT_DIR = join(UNIPROT_DIR, "dbxref")
UNIPROT_KB_DBXREF_SPLIT_FILE = join(
    UNIPROT_KB_DBXREF_SPLIT_DIR, "{ukb_basename}_dbxref_{ukb_snum}.hdf5"
)
UNIPROT_KB_DBXREF_SPLIT_FILES = []
for i, ukb_basename in enumerate(EXPAND_PARAMS["ukb_basename"]):
    UNIPROT_KB_DBXREF_SPLIT_FILES.extend(
        expand(
            UNIPROT_KB_DBXREF_SPLIT_FILE,
            ukb_basename=ukb_basename,
            ukb_snum=list(
                str(x).zfill(3)
                for x in range(
                    1,
                    int(float(config["uniprot"]["kb"]["parse"]["num_splits"][i])) + 1,
                )
            ),
        )
    )
UNIPROT_KB_DBXREF_FILE = join(UNIPROT_DIR, "uniprot_dbxref.hdf5")
UNIPROT_KB_IDMAP_FILE_URL = join(UNIPROT_KB_IDMAP_URL, UNIPROT_KB_IDMAP_FILENAME)
UNIPROT_KB_IDMAP_FILE = join(UNIPROT_DIR, UNIPROT_KB_IDMAP_FILENAME)
UNIPROT_KB_GENBANK_IDMAP_FILE = join(UNIPROT_DIR, "uniprot_genbank_idmap.hdf5")
UNIPROT_KB_GENBANK_IDMAP_DBXREF_FILE = join(
    UNIPROT_DIR, "uniprot_genbank_idmap_{ukb_dbxref_db}.hdf5"
)

EXPAND_PARAMS["asm_type"] = config["ncbi"]["assembly"]["file"]["types"]

NCBI_ASSEMBLY_SUMMARY_FILE_URL = join(NCBI_ASSEMBLY_SUMMARY_URL, "{asu_basename}.txt")
NCBI_ASSEMBLY_SUMMARY_FILE = join(NCBI_GENOME_DIR, "{asu_basename}.txt")
NCBI_ASSEMBLY_SUMMARY_FILES = [
    join(NCBI_GENOME_DIR, filename) for filename in NCBI_ASSEMBLY_SUMMARY_FILENAMES
]
NCBI_ASSEMBLY_MERGED_SUMMARY_FILE = join(NCBI_GENOME_DIR, "assembly_summary_merged.txt")
NCBI_ASSEMBLY_CDS_FASTA_FILE = join(
    NCBI_ASSEMBLY_DIR, "{asm_dir}", "{asm_dir}_cds_from_genomic.fna.gz"
)
NCBI_ASSEMBLY_FILTERED_CDS_FASTA_FILE = join(
    NCBI_ASSEMBLY_DIR,
    "{asm_dir}",
    "{asm_dir}_cds_from_genomic_filtered.fna.gz",
)
NCBI_ASSEMBLY_FASTA_LIST_FILE = join(
    NCBI_GENOME_DIR, "assembly_{asm_type}_fasta_list.txt"
)

GENCODE_SPECIES = "{gc_species}"
GENCODE_RELEASE = "{gc_release}"
GENCODE_BUILD = "{gc_build}"

EXPAND_PARAMS["gc_species"] = config["gencode"]["species"]
EXPAND_PARAMS["gc_release"] = config["gencode"]["releases"]
EXPAND_PARAMS["gc_build"] = config["gencode"]["builds"]

GENCODE_GENOME_NAME = f"{GENCODE_SPECIES}_{GENCODE_RELEASE}_{GENCODE_BUILD}"
GENCODE_GENOME_FASTA_FILE = join(GENCODE_DIR, f"{GENCODE_GENOME_NAME}.fa.gz")
GENCODE_GENOME_FIXED_FASTA_FILE = join(
    GENCODE_DIR, f"{GENCODE_GENOME_NAME}_fixed.fa.gz"
)
GENCODE_GENOME_FIXED_FASTA_ID_FILE = join(
    GENCODE_DIR, f"{GENCODE_GENOME_NAME}_fixed_fasta_ids.txt"
)
GENCODE_GENOME_MERGED_FIXED_FASTA_ID_FILE = join(
    GENCODE_DIR, "merged_fixed_fasta_ids.txt"
)
GENCODE_GENOME_ANNOT_FILE = join(
    GENCODE_DIR, f"{GENCODE_GENOME_NAME}.{GENCODE_ANNOT_FMT.lower()}.gz"
)

# match order
EXPAND_PARAMS["ref_type"] = ["merged_genomic_filtered_cds", "genomic"]
EXPAND_PARAMS["pfa_type"] = ["sam", "pam"]

REF_BASE_FASTA_FILE = join(REF_DIR, "ref_{asm_type}.fa.gz")
REF_DEDUPED_ID_BASE_FASTA_FILE = join(REF_DIR, "ref_{asm_type}_deduped_id.fa.gz")
REF_DEDUPED_QNAME_FILE = join(REF_DIR, "ref_{asm_type}_deduped_qnames.txt")
REF_CDS_FROM_GENOMIC_DEDUPED_QNAME_FILE = join(
    REF_DIR, "ref_cds_from_genomic_filtered_deduped_qnames.txt"
)
REF_DEDUPED_ID_MERGED_FASTA_FILE = join(
    REF_DIR, "ref_merged_genomic_filtered_cds_deduped_id.fa.gz"
)
REF_DEDUPED_ID_FASTA_FILE = join(REF_DIR, "ref_{ref_type}_deduped_id.fa.gz")
REF_DEDUPED_ID_MERGED_DECOY_FASTA_FILE = join(
    REF_DIR, "ref_{ref_type}_deduped_id_merged_decoy.fa.gz"
)

PUFFERFISH_INDEX_DIR = join(
    PUFFERFISH_RESOURCES_DIR, "index", "{ref_type}_deduped_id_merged_decoy"
)

TRIMMED_RESULTS_DIR = join(RESULTS_DIR, "fastp", "{data_subdir}")
PUFFERFISH_RESULTS_DIR = join(RESULTS_DIR, "pufferfish", "{data_subdir}")

FASTQ1_FILE = join(
    FASTQ_DATA_DIR, f"{RUN_ID_WILDCARD_STR}_{FASTQ_MATES[0]}.{FASTQ_EXT}"
)
FASTQ2_FILE = join(
    FASTQ_DATA_DIR, f"{RUN_ID_WILDCARD_STR}_{FASTQ_MATES[1]}.{FASTQ_EXT}"
)
TRIMMED_FASTQ1_FILE = join(
    TRIMMED_RESULTS_DIR, f"{RUN_ID_WILDCARD_STR}_{FASTQ_MATES[0]}.{FASTQ_EXT}"
)
TRIMMED_FASTQ2_FILE = join(
    TRIMMED_RESULTS_DIR, f"{RUN_ID_WILDCARD_STR}_{FASTQ_MATES[1]}.{FASTQ_EXT}"
)
TRIMMED_UNPAIR1_FILE = join(
    TRIMMED_RESULTS_DIR, f"{RUN_ID_WILDCARD_STR}_U1.{FASTQ_EXT}"
)
TRIMMED_UNPAIR2_FILE = join(
    TRIMMED_RESULTS_DIR, f"{RUN_ID_WILDCARD_STR}_U2.{FASTQ_EXT}"
)
FAILED_READS_FILE = join(
    TRIMMED_RESULTS_DIR, f"{RUN_ID_WILDCARD_STR}_failed.{FASTQ_EXT}"
)
FASTP_HTML_REPORT_FILE = join(TRIMMED_RESULTS_DIR, f"{RUN_ID_WILDCARD_STR}_report.html")
FASTP_JSON_REPORT_FILE = join(TRIMMED_RESULTS_DIR, f"{RUN_ID_WILDCARD_STR}_report.json")

PUFFERFISH_ALIGN_FILE = join(
    PUFFERFISH_RESULTS_DIR, f"{RUN_ID_WILDCARD_STR}_{{ref_type}}.{{pfa_type}}"
)
PUFFERFISH_GENOMIC_PAM_FILE = join(
    PUFFERFISH_RESULTS_DIR, f"{RUN_ID_WILDCARD_STR}_genomic.pam"
)
PUFFERFISH_MERGED_GENOMIC_FILTERED_CDS_SAM_FILE = join(
    PUFFERFISH_RESULTS_DIR, f"{RUN_ID_WILDCARD_STR}_merged_genomic_filtered_cds.sam"
)
PUFFERFISH_MERGED_GENOMIC_FILTERED_CDS_BAM_FILE = join(
    PUFFERFISH_RESULTS_DIR, f"{RUN_ID_WILDCARD_STR}_merged_genomic_filtered_cds.bam"
)
PUFFERFISH_FILTERED_CDS_BAM_FILE = join(
    PUFFERFISH_RESULTS_DIR, f"{RUN_ID_WILDCARD_STR}_filtered_cds.bam"
)
PUFFERFISH_FILTERED_CDS_READ_QUANT_TSV_FILE = join(
    PUFFERFISH_RESULTS_DIR, f"{RUN_ID_WILDCARD_STR}_filtered_cds_read_quant.tsv.gz"
)
PUFFERFISH_FILTERED_CDS_READ_QUANT_HDF_FILE = join(
    PUFFERFISH_RESULTS_DIR, f"{RUN_ID_WILDCARD_STR}_filtered_cds_read_quant.hdf5"
)

EXPAND_PARAMS["a2t_basename"] = [
    splitext(filename)[0] for filename in NCBI_ACC2TAXID_FILENAMES
]
EXPAND_PARAMS["asu_basename"] = [
    splitext(filename)[0] for filename in NCBI_ASSEMBLY_SUMMARY_FILENAMES
]

NCBI_ACC2TAXID_URL = join(NCBI_ACC2TAXID_URL, "{a2t_basename}.gz")
NCBI_ACC2TAXID_FILE = join(NCBI_TAXONOMY_DIR, "{a2t_basename}.gz")
NCBI_ACC2TAXID_FILTERED_MERGED_FILE = join(
    NCBI_TAXONOMY_DIR, "ncbi_acc2taxid_filtered_merged.gz"
)
NCBI_TAXDUMP_ZIP_URL = join(NCBI_TAXDUMP_URL, NCBI_TAXDUMP_ZIP_FILENAME)
NCBI_TAXDUMP_ZIP_FILE = join(NCBI_TAXONOMY_DIR, NCBI_TAXDUMP_ZIP_FILENAME)
NCBI_TAXDUMP_FILES = [
    join(NCBI_TAXONOMY_DIR, filename) for filename in NCBI_TAXDUMP_FILENAMES
]
NCBI_TAXDUMP_NODES_FILE = [f for f in NCBI_TAXDUMP_FILES if f.startswith("nodes")][0]

CEDAR_READ_QUANT_TSV_FILE = join(
    PUFFERFISH_RESULTS_DIR, f"{RUN_ID_WILDCARD_STR}_cedar_read_quant.tsv.gz"
)
CEDAR_READ_QUANT_HDF_FILE = join(
    PUFFERFISH_RESULTS_DIR, f"{RUN_ID_WILDCARD_STR}_cedar_read_quant.hdf5"
)

DATA_SUBDIRS = list(set(EXPAND_PARAMS["data_subdir"]))
if len(DATA_SUBDIRS) == 1:
    DATA_MATRIX_RESULTS_DIR = join(RESULTS_DIR, "data_matrix", DATA_SUBDIRS[0])
    DATA_MATRIX_LOG_DIR = join(LOG_DIR, "data_matrix", DATA_SUBDIRS[0])
else:
    DATA_MATRIX_RESULTS_DIR = join(RESULTS_DIR, "data_matrix", STUDY_NAME)
    DATA_MATRIX_LOG_DIR = join(LOG_DIR, "data_matrix", STUDY_NAME)

PUFFERFISH_FILTERED_CDS_COUNT_MATRIX_FILE = join(
    DATA_MATRIX_RESULTS_DIR, f"{STUDY_NAME}_filtered_cds_count_matrix.tsv.gz"
)
UNIPROT_KB_DBXREF_COUNT_MATRIX_FILE = join(
    DATA_MATRIX_RESULTS_DIR, f"{STUDY_NAME}_{{ukb_dbxref_db}}_count_matrix.tsv.gz"
)

CEDAR_COUNT_MATRIX_FILE = join(
    DATA_MATRIX_RESULTS_DIR, f"{STUDY_NAME}_cedar_count_matrix.tsv.gz"
)
CEDAR_COUNT_ESET_FILE = join(
    DATA_MATRIX_RESULTS_DIR, f"{STUDY_NAME}_cedar_count_eset.rds"
)

UNIPROT_LOG_DIR = join(LOG_DIR, "uniprot")
NCBI_GENOME_LOG_DIR = join(LOG_DIR, "genomes")
NCBI_ASSEMBLY_LOG_DIR = join(NCBI_GENOME_LOG_DIR, "assemblies")
GENCODE_LOG_DIR = join(LOG_DIR, "gencode")
REF_LOG_DIR = join(LOG_DIR, "ref")
PUFFERFISH_LOG_DIR = join(LOG_DIR, "pufferfish")
FASTP_LOG_DIR = join(LOG_DIR, "fastp", "{data_subdir}")
NCBI_TAXNOMY_LOG_DIR = join(LOG_DIR, "taxonomy")

UNIPROT_PROTEOMES_LOG = join(UNIPROT_LOG_DIR, "uniprot_proteomes.log")
UNIPROT_KB_XML_LOG = join(UNIPROT_LOG_DIR, "{ukb_basename}_xml.log")
UNIPROT_KB_FASTA_LOG = join(UNIPROT_LOG_DIR, "{ukb_basename}_fasta.log")
UNIPROT_KB_XML_SPLIT_POS_LOG = join(UNIPROT_LOG_DIR, "{ukb_basename}_xml_split_pos.log")
UNIPROT_KB_DBXREF_SPLIT_LOG = join(
    UNIPROT_LOG_DIR, "{ukb_basename}_dbxref_{ukb_snum}.log"
)
UNIPROT_KB_DBXREF_LOG = join(UNIPROT_LOG_DIR, "uniprot_kb_merged_dbxref.log")
UNIPROT_KB_IDMAP_LOG = join(UNIPROT_LOG_DIR, "uniprot_kb_idmap.log")
UNIPROT_KB_GENBANK_IDMAP_LOG = join(UNIPROT_LOG_DIR, "uniprot_kb_genbank_idmap.log")
UNIPROT_KB_GENBANK_IDMAP_DBXREF_LOG = join(
    UNIPROT_LOG_DIR, "uniprot_kb_genbank_idmap_{ukb_dbxref_db}.log"
)

NCBI_ASSEMBLY_SUMMARY_LOG = join(NCBI_GENOME_LOG_DIR, "ncbi_{asu_basename}.log")
NCBI_ASSEMBLY_MERGED_SUMMARY_LOG = join(
    NCBI_GENOME_LOG_DIR, "ncbi_assembly_merged_summary.log"
)
NCBI_ASSEMBLY_FILES_LOG = join(NCBI_GENOME_LOG_DIR, "ncbi_assemblies.log")
NCBI_ASSEMBLY_FILTERED_CDS_FASTA_LOG = join(
    NCBI_GENOME_LOG_DIR, "{asm_dir}_cds_from_genomic_filtered_fasta.log"
)
NCBI_ASSEMBLY_FASTA_LIST_LOG = join(
    NCBI_GENOME_LOG_DIR, "ncbi_assembly_{asm_type}_fasta_list.log"
)

GENCODE_GENOME_FIXED_FASTA_LOG = join(
    GENCODE_LOG_DIR, f"gencode_{GENCODE_GENOME_NAME}_fa.log"
)
GENCODE_GENOME_FIXED_FASTA_ID_LOG = join(
    GENCODE_LOG_DIR, f"gencode_{GENCODE_GENOME_NAME}_fasta_ids.log"
)
GENCODE_GENOME_MERGED_FIXED_FASTA_ID_LOG = join(
    GENCODE_LOG_DIR, "gencode_genome_merged_fixed_fasta_ids.log"
)

REF_BASE_FASTA_LOG = join(REF_LOG_DIR, "ref_{asm_type}_fasta.log")
REF_DEDUPED_ID_BASE_FASTA_LOG = join(REF_LOG_DIR, "ref_{asm_type}_deduped_id_fasta.log")
REF_DEDUPED_QNAME_LOG = join(REF_LOG_DIR, "ref_{asm_type}_deduped_qnames.log")
REF_DEDUPED_ID_MERGED_FASTA_LOG = join(
    REF_LOG_DIR, "ref_merged_genomic_filtered_cds_deduped_id_fasta.log"
)
REF_DEDUPED_ID_MERGED_DECOY_FASTA_LOG = join(
    REF_LOG_DIR, "ref_{ref_type}_deduped_id_merged_decoy_fasta.log"
)

PUFFERFISH_INDEX_LOG_DIR = join(PUFFERFISH_LOG_DIR, "index")
PUFFERFISH_INDEX_LOG = join(
    PUFFERFISH_INDEX_LOG_DIR, "pufferfish_{ref_type}_deduped_id_merged_decoy_index.log"
)

FASTP_LOG = join(FASTP_LOG_DIR, f"{RUN_ID_WILDCARD_STR}.log")

PUFFERFISH_ALIGN_LOG_DIR = join(PUFFERFISH_LOG_DIR, "align", "{data_subdir}")
PUFFERFISH_ALIGN_LOG = join(
    PUFFERFISH_ALIGN_LOG_DIR, f"{RUN_ID_WILDCARD_STR}_{{ref_type}}_{{pfa_type}}.log"
)
PUFFERFISH_ALIGN_BAM_LOG = join(
    PUFFERFISH_ALIGN_LOG_DIR, f"{RUN_ID_WILDCARD_STR}_{{ref_type}}_bam.log"
)
PUFFERFISH_MERGED_GENOMIC_FILTERED_CDS_BAM_LOG = join(
    PUFFERFISH_LOG_DIR,
    "{data_subdir}",
    f"{RUN_ID_WILDCARD_STR}_merged_genomic_filtered_cds_bam.log",
)
PUFFERFISH_FILTERED_CDS_BAM_LOG = join(
    PUFFERFISH_LOG_DIR, "{data_subdir}", f"{RUN_ID_WILDCARD_STR}_filtered_cds_bam.log"
)
PUFFERFISH_FILTERED_CDS_READ_QUANT_TSV_LOG = join(
    PUFFERFISH_LOG_DIR,
    "{data_subdir}",
    f"{RUN_ID_WILDCARD_STR}_filtered_cds_read_quant_tsv.log",
)
PUFFERFISH_FILTERED_CDS_READ_QUANT_HDF_LOG = join(
    PUFFERFISH_LOG_DIR,
    "{data_subdir}",
    f"{RUN_ID_WILDCARD_STR}_filtered_cds_read_quant_hdf.log",
)
PUFFERFISH_FILTERED_CDS_COUNT_MATRIX_LOG = join(
    DATA_MATRIX_LOG_DIR, f"{STUDY_NAME}_filtered_cds_count_matrix.log"
)
UNIPROT_KB_DBXREF_COUNT_MATRIX_LOG = join(
    DATA_MATRIX_LOG_DIR, f"{STUDY_NAME}_{{ukb_dbxref_db}}_count_matrix.log"
)

NCBI_ACC2TAXID_LOG = join(NCBI_TAXNOMY_LOG_DIR, "ncbi_{a2t_basename}.log")
NCBI_ACC2TAXID_FILTERED_MERGED_LOG = join(
    NCBI_TAXNOMY_LOG_DIR, "ncbi_acc2taxid_filtered_merged.log"
)
NCBI_TAXDUMP_ZIP_LOG = join(NCBI_TAXNOMY_LOG_DIR, "ncbi_taxdump_zip.log")
NCBI_TAXDUMP_FILES_LOG = join(NCBI_TAXNOMY_LOG_DIR, "ncbi_taxdump_files.log")

CEDAR_READ_QUANT_TSV_LOG = join(
    PUFFERFISH_LOG_DIR,
    "{data_subdir}",
    f"{RUN_ID_WILDCARD_STR}_cedar_read_quant_tsv.log",
)
CEDAR_READ_QUANT_HDF_LOG = join(
    PUFFERFISH_LOG_DIR,
    "{data_subdir}",
    f"{RUN_ID_WILDCARD_STR}_cedar_read_quant_hdf.log",
)

CEDAR_COUNT_MATRIX_LOG = join(
    DATA_MATRIX_LOG_DIR, f"{STUDY_NAME}_cedar_count_matrix.log"
)
CEDAR_COUNT_ESET_LOG = join(DATA_MATRIX_LOG_DIR, f"{STUDY_NAME}_cedar_count_eset.log")

UNIPROT_KB_GENBANK_IDMAP_DBXREF_THREADS = (
    workflow.cores
    if config["uniprot"]["kb"]["idmap"]["threads"] == "all"
    else config["uniprot"]["kb"]["idmap"]["threads"]
)
NCBI_ASSEMBLY_FILE_DOWNLOAD_THREADS = (
    workflow.cores
    if config["ncbi"]["assembly"]["file"]["download"]["threads"] == "all"
    else config["ncbi"]["assembly"]["file"]["download"]["threads"]
)
REF_PIGZ_THREADS = (
    workflow.cores
    if config["ref"]["pigz"]["threads"] == "all"
    else config["ref"]["pigz"]["threads"]
)
PUFFERFISH_INDEX_THREADS = (
    workflow.cores
    if config["pufferfish"]["index"]["threads"] == "all"
    else config["pufferfish"]["index"]["threads"]
)
PUFFERFISH_ALIGN_THREADS = (
    workflow.cores
    if config["pufferfish"]["align"]["threads"] == "all"
    else config["pufferfish"]["align"]["threads"]
)
SAMTOOLS_VIEW_THREADS = (
    workflow.cores
    if config["samtools"]["view"]["threads"] == "all"
    else config["samtools"]["view"]["threads"]
)
CDS_READ_QUANT_THREADS = (
    workflow.cores
    if config["cds"]["quant"]["threads"] == "all"
    else config["cds"]["quant"]["threads"]
)
CEDAR_READ_QUANT_THREADS = (
    workflow.cores
    if config["pufferfish"]["cedar"]["threads"] == "all"
    else config["pufferfish"]["cedar"]["threads"]
)

GENCODE_GENOME_SEQ_WRAPPER = join(
    config["wrapper"]["base_url"], "bio/reference/gencode/sequence"
)
GENCODE_GENOME_ANNOT_WRAPPER = join(
    config["wrapper"]["base_url"], "bio/reference/gencode/annotation"
)
SEQKIT_BAM_WRAPPER = join(config["wrapper"]["base_url"], "bio/seqkit/bam")
SEQKIT_GREP_WRAPPER = join(config["wrapper"]["base_url"], "bio/seqkit/grep")
SEQKIT_RENAME_WRAPPER = join(config["wrapper"]["base_url"], "bio/seqkit/rename")
SEQKIT_REPLACE_WRAPPER = join(config["wrapper"]["base_url"], "bio/seqkit/replace")
SEQKIT_SEQ_WRAPPER = join(config["wrapper"]["base_url"], "bio/seqkit/seq")
PUFFERFISH_INDEX_WRAPPER = join(config["wrapper"]["base_url"], "bio/pufferfish/index")
FASTP_WRAPPER = join(config["wrapper"]["base_url"], "bio/fastp")
PUFFERFISH_ALIGN_WRAPPER = join(config["wrapper"]["base_url"], "bio/pufferfish/align")
SAMTOOLS_VIEW_WRAPPER = join(config["wrapper"]["base_url"], "bio/samtools/view")
CEDAR_READ_QUANT_WRAPPER = join(config["wrapper"]["base_url"], "bio/pufferfish/cedar")
DATA_MATRIX_WRAPPER = join(config["wrapper"]["base_url"], "bio/pufferfish/data_matrix")
ESET_WRAPPER = join(config["wrapper"]["base_url"], "bio/biobase/eset")


include: join(RULES_DIR, "common.smk")
include: join(RULES_DIR, "proteomes.smk")
include: join(RULES_DIR, "microbe_genomes.smk")
include: join(RULES_DIR, "taxonomy.smk")
include: join(RULES_DIR, "host_genomes.smk")
include: join(RULES_DIR, "ref.smk")
include: join(RULES_DIR, "index.smk")
include: join(RULES_DIR, "trim.smk")
include: join(RULES_DIR, "align.smk")
include: join(RULES_DIR, "quant.smk")
include: join(RULES_DIR, "data_matrix.smk")


wildcard_constraints:
    **{w: "|".join(set([re.escape(v) for v in l])) for w, l in EXPAND_PARAMS.items()},


rule all:
    input:
        UNIPROT_PROTEOMES_FILE,
        expand(UNIPROT_KB_XML_FILE, zip, **EXPAND_PARAMS),
        expand(UNIPROT_KB_FASTA_FILE, zip, **EXPAND_PARAMS),
        expand(UNIPROT_KB_XML_SPLIT_POS_FILE, zip, **EXPAND_PARAMS),
        UNIPROT_KB_DBXREF_FILE,
        UNIPROT_KB_IDMAP_FILE,
        UNIPROT_KB_GENBANK_IDMAP_FILE,
        expand(UNIPROT_KB_GENBANK_IDMAP_DBXREF_FILE, zip, **EXPAND_PARAMS),
        expand(NCBI_ASSEMBLY_SUMMARY_FILE, zip, **EXPAND_PARAMS),
        NCBI_ASSEMBLY_MERGED_SUMMARY_FILE,
        NCBI_ASSEMBLY_DIR,
        expand(NCBI_ASSEMBLY_FASTA_LIST_FILE, zip, **EXPAND_PARAMS),
        expand(GENCODE_GENOME_FASTA_FILE, zip, **EXPAND_PARAMS),
        expand(GENCODE_GENOME_FIXED_FASTA_FILE, zip, **EXPAND_PARAMS),
        expand(GENCODE_GENOME_FIXED_FASTA_ID_FILE, zip, **EXPAND_PARAMS),
        GENCODE_GENOME_MERGED_FIXED_FASTA_ID_FILE,
        expand(GENCODE_GENOME_ANNOT_FILE, zip, **EXPAND_PARAMS),
        expand(REF_BASE_FASTA_FILE, zip, **EXPAND_PARAMS),
        expand(REF_DEDUPED_ID_BASE_FASTA_FILE, zip, **EXPAND_PARAMS),
        expand(REF_DEDUPED_QNAME_FILE, zip, **EXPAND_PARAMS),
        REF_DEDUPED_ID_MERGED_FASTA_FILE,
        expand(REF_DEDUPED_ID_FASTA_FILE, zip, **EXPAND_PARAMS),
        expand(REF_DEDUPED_ID_MERGED_DECOY_FASTA_FILE, zip, **EXPAND_PARAMS),
        expand(PUFFERFISH_INDEX_DIR, zip, **EXPAND_PARAMS),
        expand(TRIMMED_FASTQ1_FILE, zip, **EXPAND_PARAMS),
        expand(TRIMMED_FASTQ2_FILE, zip, **EXPAND_PARAMS),
        expand(PUFFERFISH_ALIGN_FILE, zip, **EXPAND_PARAMS),
        expand(PUFFERFISH_MERGED_GENOMIC_FILTERED_CDS_BAM_FILE, zip, **EXPAND_PARAMS),
        expand(PUFFERFISH_FILTERED_CDS_BAM_FILE, zip, **EXPAND_PARAMS),
        expand(PUFFERFISH_FILTERED_CDS_READ_QUANT_TSV_FILE, zip, **EXPAND_PARAMS),
        expand(PUFFERFISH_FILTERED_CDS_READ_QUANT_HDF_FILE, zip, **EXPAND_PARAMS),
        PUFFERFISH_FILTERED_CDS_COUNT_MATRIX_FILE,
        expand(NCBI_ACC2TAXID_FILE, zip, **EXPAND_PARAMS),
        NCBI_ACC2TAXID_FILTERED_MERGED_FILE,
        NCBI_TAXDUMP_ZIP_FILE,
        NCBI_TAXDUMP_FILES,
        expand(CEDAR_READ_QUANT_TSV_FILE, zip, **EXPAND_PARAMS),
        expand(CEDAR_READ_QUANT_HDF_FILE, zip, **EXPAND_PARAMS),
        CEDAR_COUNT_MATRIX_FILE,
        CEDAR_COUNT_ESET_FILE,


def clean(*dirs):
    for clean_dir in dirs:
        if exists(clean_dir):
            rmtree(clean_dir)
        for dirpath, dirnames, filenames in sorted(walk(getcwd())):
            for name in dirnames:
                if name == "__pycache__":
                    pycache_dir = join(dirpath, name)
                    if exists(pycache_dir):
                        rmtree(pycache_dir)


rule clean:
    run:
        clean(RESULTS_DIR, LOG_DIR)


rule clean_all:
    run:
        clean(RESOURCES_DIR, RESULTS_DIR, LOG_DIR)
